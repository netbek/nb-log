/*
 * nb-log
 * 
 * @author Hein Bekker <hein@netbek.co.za>
 * @copyright (c) 2015 Hein Bekker
 * @license http://www.gnu.org/licenses/agpl-3.0.txt AGPLv3
 */
!function(a,b,c){"use strict";function d(){var a={delegate:!0,http_default_error:"An error has occured. Please contact customer support for assistance.",http_network_error:"Unable to communicate with the server. Make sure you are connected to the internet and try again.",levels:g,logs:{app:{enabled:!1,level:"log",maxSize:10},console:{enabled:!1,level:"log",maxSize:10},http:{enabled:!1,level:"log",url:c,maxSize:10}},on:{log:[],debug:[],info:[],warn:[],error:[]}};return{set:function(b){_.merge(a,b)},$get:function(){return a}}}function e(a,d,e){return function(f){function h(){return w||(w=!0,p=a.get("$httpBackend"),q=a.get("$q"),r=a.get("$timeout"),s=a.get("moment"),t=a.get("nbI18N"),u=q.defer(),b.forEach(e.logs,function(a,b){var c;if("app"==b)c=new m;else if("console"==b)c=new n;else{if("http"!=b)return;c=new o}v[b]=c}),u.resolve(t.t("!variable initialized",{"!variable":"$log"}))),u.promise}function i(a,c,d){e.delegate&&f[a]("error"===a&&d?d:c);var g=h(),i=new k(a,c,d),j=q.defer();return g.then(function(){var c=[];b.forEach(e.on[a],function(a){a(i)}),b.forEach(e.logs,function(b,d){c.push(v[d].emit(a,i))}),q.all(c).then(function(a){j.resolve(a)})["catch"](function(a){j.reject(a),f.warn(a)})})["catch"](function(a){j.reject(a),f.warn(a)}),j.promise}function j(a){if(!a)return c;var e={};return a instanceof Error?(b.forEach(a,function(a,b){e[b]=a}),e.name=a.name,e.message=a.toString(),e.stack=a.stack||"",e.code=a.code,e.url=a.url||d.location.href):e.message=a+"",e}function k(a,b,c){this.time=s().format(),this.level=a,this.msg=b,this.err=j(c)}function l(a){this.isInitialized=!1,this.isReady=!1,this.deferredInit=q.defer(),this.id=a,this.entries=[]}function m(){l.call(this),this.id="app"}function n(){l.call(this),this.id="console"}function o(){l.call(this),this.id="http"}var p,q,r,s,t,u,v={},w=!1;return l.prototype.init=function(){return this.isInitialized||(this.isInitialized=!0,this.isReady=!0,this.deferredInit.resolve(t.t("Log `!logId` is ready",{"!logId":this.id}))),this.deferredInit.promise},l.prototype.emit=function(a,b){var c=this,d=e.logs[this.id],f=q.defer();return this.init().then(function(){d.enabled&&g[a]>=g[d.level]?(c.entries.length>=d.maxSize&&c.entries.shift(),c.entries.push(b),f.resolve(t.t("Added entry to log `!logId`",{"!logId":c.id}))):f.resolve()})["catch"](function(a){f.reject(a)}),f.promise},m.prototype=_.create(l.prototype,{constructor:m}),n.prototype=_.create(l.prototype,{constructor:n}),n.prototype.emit=function(a,b){var c=this,d=e.logs[this.id],f=q.defer();return this.init().then(function(){d.enabled&&d.level&&g[a]>=g[d.level]?(c.entries.length>=d.maxSize&&c.entries.shift(),c.entries.push(b),!e.delegate&&console&&a in console&&console[a]("error"===a&&b.err?b.err:b.msg),f.resolve(t.t("Added entry to log `!logId`",{"!logId":c.id}))):f.resolve()})["catch"](function(a){f.reject(a)}),f.promise},o.prototype=_.create(l.prototype,{constructor:o}),o.prototype.init=function(){if(!this.isInitialized){this.isInitialized=!0;var a=e.logs[this.id];a.enabled&&!a.url?(this.isReady=!1,this.deferredInit.reject(t.t("Log `!logId` endpoint URL is required",{"!logId":this.id}))):(this.isReady=!0,this.deferredInit.resolve(t.t("Log `!logId` is ready",{"!logId":this.id})))}return this.deferredInit.promise},o.prototype.emit=function(a,c){var d=this,f=e.logs[this.id],h=q.defer();return this.init().then(function(){f.enabled&&g[a]>=g[f.level]?(d.entries.length>=f.maxSize&&d.entries.shift(),d.entries.push(c),p("POST",f.url,b.toJson(c),b.noop,{"content-type":"application/json"}),h.resolve(t.t("Added entry to log `!logId`",{"!logId":d.id}))):h.resolve()})["catch"](function(a){h.reject(a)}),h.promise},{getEntries:function(a){return a in v?v[a].entries:[]},$on:function(a,b){e.on[a].push(b)},log:function(a){return i("log",a)},debug:function(a){return i("debug",a)},info:function(a){return i("info",a)},warn:function(a){return i("warn",a)},error:function(a,b){return a instanceof Error?i("error",a.message,a):i("error",a,b)}}}}function f(a,b,c){return{responseError:function(d){var e=Number(d.status),f=d.statusText||c.http_default_error;return 0===e&&(f=c.http_network_error),b.warn({message:f,url:d.config.url}),a.reject(d)}}}b.module("nb.log",["nb.i18n","nb.lodash","nb.moment"]).factory("nbLog",e).provider("nbLogConfig",d).factory("nbLogHttpInterceptor",f);var g={log:10,debug:20,info:30,warn:40,error:50};e.$inject=["$injector","$window","nbLogConfig"],f.$inject=["$q","$log","nbLogConfig"]}(window,window.angular);