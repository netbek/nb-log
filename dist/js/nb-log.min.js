/*
 * nb-log
 * 
 * @author Hein Bekker <hein@netbek.co.za>
 * @copyright (c) 2015 Hein Bekker
 * @license http://www.gnu.org/licenses/agpl-3.0.txt AGPLv3
 */
!function(a,b,c){"use strict";function d(){var b={delegate:!0,http_default_error:"An error has occured. Please contact customer support for assistance.",http_network_error:"Unable to communicate with the server. Make sure you are connected to the internet and try again.",levels:h,logs:{app:{enabled:!1,level:"log",maxSize:10},console:{enabled:!1,level:"log",maxSize:10},http:{enabled:!1,level:"log",url:c,maxSize:10}},on:{log:[],debug:[],info:[],warn:[],error:[]}};return{set:function(c){b=a.merge.recursive(!0,b,c)},$get:function(){return b}}}function e(a,d,e){return function(f){function i(){return x||(x=!0,q=a.get("$httpBackend"),r=a.get("$q"),s=a.get("$timeout"),t=a.get("Moment"),u=a.get("nbI18N"),v=r.defer(),b.forEach(e.logs,function(a,b){var c;if("app"==b)c=new n;else if("console"==b)c=new o;else{if("http"!=b)return;c=new p}w[b]=c}),v.resolve(u.t("!variable initialized",{"!variable":"$log"}))),v.promise}function j(a,c,d){e.delegate&&f[a]("error"===a&&d?d:c);var g=i(),h=new l(c,d),j=r.defer();return g.then(function(){var c=[];b.forEach(e.on[a],function(a){a(h)}),b.forEach(e.logs,function(b,d){c.push(w[d].emit(a,h))}),r.all(c).then(function(a){j.resolve(a)})["catch"](function(a){j.reject(a),f.warn(a)})})["catch"](function(a){j.reject(a),f.warn(a)}),j.promise}function k(a){if(!a)return c;var e={};return a instanceof Error?(b.forEach(a,function(a,b){e[b]=a}),e.name=a.name,e.message=a.toString(),e.stack=a.stack||"",e.code=a.code,e.url=a.url||d.location.href):e.message=a+"",e}function l(a,b){this.time=t().format(),this.msg=a,this.err=k(b)}function m(a){this.isInitialized=!1,this.isReady=!1,this.deferredInit=r.defer(),this.id=a,this.entries=[]}function n(){m.call(this),this.id="app"}function o(){m.call(this),this.id="console"}function p(){m.call(this),this.id="http"}var q,r,s,t,u,v,w={},x=!1;return m.prototype.init=function(){return this.isInitialized||(this.isInitialized=!0,this.isReady=!0,this.deferredInit.resolve(u.t("Log `!logId` is ready",{"!logId":this.id}))),this.deferredInit.promise},m.prototype.emit=function(a,b){var c=this,d=e.logs[this.id],f=r.defer();return this.init().then(function(){d.enabled&&h[a]>=h[d.level]?(c.entries.length>=d.maxSize&&c.entries.shift(),c.entries.push(b),f.resolve(u.t("Added entry to log `!logId`",{"!logId":c.id}))):f.resolve()})["catch"](function(a){f.reject(a)}),f.promise},n.prototype=g(m.prototype),n.prototype.constructor=n,o.prototype=g(m.prototype),o.prototype.constructor=o,o.prototype.emit=function(a,b){var c=this,d=e.logs[this.id],f=r.defer();return this.init().then(function(){d.enabled&&d.level&&h[a]>=h[d.level]?(c.entries.length>=d.maxSize&&c.entries.shift(),c.entries.push(b),!e.delegate&&console&&a in console&&console[a]("error"===a&&b.err?b.err:b.msg),f.resolve(u.t("Added entry to log `!logId`",{"!logId":c.id}))):f.resolve()})["catch"](function(a){f.reject(a)}),f.promise},p.prototype=g(m.prototype),p.prototype.constructor=p,p.prototype.init=function(){if(!this.isInitialized){this.isInitialized=!0;var a=e.logs[this.id];a.enabled&&!a.url?(this.isReady=!1,this.deferredInit.reject(u.t("Log `!logId` endpoint URL is required",{"!logId":this.id}))):(this.isReady=!0,this.deferredInit.resolve(u.t("Log `!logId` is ready",{"!logId":this.id})))}return this.deferredInit.promise},p.prototype.emit=function(a,c){var d=this,f=e.logs[this.id],g=r.defer();return this.init().then(function(){f.enabled&&h[a]>=h[f.level]?(d.entries.length>=f.maxSize&&d.entries.shift(),d.entries.push(c),q("POST",f.url,b.toJson(c),b.noop,{"content-type":"application/json"}),g.resolve(u.t("Added entry to log `!logId`",{"!logId":d.id}))):g.resolve()})["catch"](function(a){g.reject(a)}),g.promise},{$on:function(a,b){e.on[a].push(b)},log:function(a){return j("log",a)},debug:function(a){return j("debug",a)},info:function(a){return j("info",a)},warn:function(a){return j("warn",a)},error:function(a,b){return a instanceof Error?j("error",a.message,a):j("error",a,b)}}}}function f(a,b,c){return{responseError:function(d){var e=Number(d.status),f=d.statusText||c.http_default_error;return 0===e&&(f=c.http_network_error),b.warn({message:f,url:d.config.url}),a.reject(d)}}}function g(a){return"function"==Object.create?Object.create(a):i(a)}b.module("nb.log",["nb.i18n","nb.moment"]).factory("nbLog",e).provider("nbLogConfig",d).factory("nbLogHttpInterceptor",f);var h={log:10,debug:20,info:30,warn:40,error:50};e.$inject=["$injector","$window","nbLogConfig"],f.$inject=["$q","$log","nbLogConfig"];var i=function(){var a=function(){};return function(b){if(arguments.length>1)throw Error("Second argument not supported");if("object"!=typeof b)throw TypeError("Argument must be an object");a.prototype=b;var c=new a;return a.prototype=null,c}}()}(window,window.angular);